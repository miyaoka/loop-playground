<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Loop Animation</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: system-ui, sans-serif;
        padding: 40px;
        background: #f5f5f5;
      }

      h1 {
        margin-bottom: 20px;
      }

      h2 {
        margin: 20px 0 10px;
      }

      /* 2カラムレイアウト（JS生成） */
      .compare {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px;
        margin-bottom: 40px;
      }

      .compare-column h3 {
        margin-bottom: 10px;
      }

      /* ループコンテナ（共通スタイル） */
      .loop,
      .loop-static {
        display: flex;
        width: 500px;
        overflow: hidden;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        position: relative;
      }

      /* スクロールするトラック */
      .loop-track {
        position: relative;
        display: flex;
        animation: scroll var(--duration, 10s) linear infinite;
      }

      /* cloneは親の幅分右にオフセット */
      .loop-clone {
        position: absolute;
        left: 100%;
        top: 0;
        display: flex;
      }

      @keyframes scroll {
        0% {
          transform: translateX(0);
        }
        100% {
          transform: translateX(-100%);
        }
      }

      /* アイテムのスタイル（デモ用） */
      .item {
        flex-shrink: 0;
        padding: 20px 40px;
        margin: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 8px;
        font-weight: bold;
        white-space: nowrap;
      }

      /* ホバーで一時停止 */
      .loop:hover .loop-track {
        animation-play-state: paused;
      }

      /* デバッグ用：cloneされた要素を薄く表示 */
      .loop-clone .item {
        opacity: 0.6;
      }
    </style>
  </head>
  <body>
    <h1>Loop Animation Demo</h1>

    <!-- 基本 -->
    <h2>基本（テキストのみ）</h2>
    <div class="loop-static">
      <div class="item">Item 1</div>
      <div class="item">Item 2</div>
      <div class="item">Item 3</div>
      <div class="item">Item 4</div>
      <div class="item">Item 5</div>
    </div>

    <!-- 雑多なコンテンツ -->
    <h2>雑多なコンテンツ</h2>
    <div class="loop-static">
      <div class="item">テキストアイテム</div>
      <div class="item">
        <img
          src="https://picsum.photos/120/80"
          alt="sample image"
          style="display: block; border-radius: 4px"
        />
      </div>
      <div class="item" style="padding: 10px">
        <iframe
          width="560"
          height="315"
          src="https://www.youtube.com/embed/GQigLJ6iV4Y?si=Zgzs1CVpn43QP3D4"
          title="YouTube video player"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          referrerpolicy="strict-origin-when-cross-origin"
          allowfullscreen
        ></iframe>
      </div>
      <div class="item">短い</div>
      <div class="item" style="width: 200px">
        <p style="margin: 0">長めのテキストコンテンツ。複数行になる場合のテスト。</p>
      </div>
      <div class="item">
        <img
          src="https://picsum.photos/80/80"
          alt="square image"
          style="display: block; border-radius: 4px"
        />
      </div>
    </div>

    <!-- コンテンツが少ない場合 -->
    <h2>コンテンツが少ない場合</h2>
    <div class="loop-static">
      <div class="item">Only One</div>
    </div>

    <!-- コンテンツが多い場合 -->
    <h2>コンテンツが多い場合</h2>
    <div class="loop-static">
      <div class="item">A</div>
      <div class="item">B</div>
      <div class="item">C</div>
      <div class="item">D</div>
      <div class="item">E</div>
      <div class="item">F</div>
      <div class="item">G</div>
      <div class="item">H</div>
      <div class="item">I</div>
      <div class="item">J</div>
    </div>

    <!-- 動的コンテンツ -->
    <h2>動的コンテンツ</h2>
    <div class="loop-static" id="dynamic-container">
      <div class="item">Static</div>
      <div class="item" id="dynamic-item">Loading...</div>
      <div class="item">Static</div>
    </div>

    <script>
      function initLoop(container) {
        const items = Array.from(container.children);

        // トラック要素を作成
        const track = document.createElement("div");
        track.className = "loop-track";

        // オリジナル要素をトラックに移動
        items.forEach((item) => {
          track.appendChild(item);
        });

        // トラックをコンテナに追加（幅計測のため先に追加）
        container.appendChild(track);

        // clone用のコンテナを作成
        const cloneContainer = document.createElement("div");
        cloneContainer.className = "loop-clone";
        track.appendChild(cloneContainer);

        // 幅とcloneを更新する関数
        function updateLayout() {
          // 一時的にcloneを空にして幅を計測
          cloneContainer.innerHTML = "";

          const containerWidth = container.offsetWidth;
          const contentWidth = track.scrollWidth;
          const trackWidth = Math.max(containerWidth, contentWidth);

          // cloneを再作成
          const currentItems = track.querySelectorAll(":scope > .item");
          currentItems.forEach((item) => {
            const clone = item.cloneNode(true);
            cloneContainer.appendChild(clone);
          });

          // 幅を設定
          track.style.width = `${trackWidth}px`;
          cloneContainer.style.left = `${trackWidth}px`;
        }

        // 初回レイアウト
        updateLayout();

        // ResizeObserver でサイズ変更を監視
        const resizeObserver = new ResizeObserver(() => {
          updateLayout();
        });

        // 各アイテムを監視
        track.querySelectorAll(":scope > .item").forEach((item) => {
          resizeObserver.observe(item);
        });

        // MutationObserver でコンテンツ変更を監視
        const mutationObserver = new MutationObserver(() => {
          updateLayout();
        });
        track.querySelectorAll(":scope > .item").forEach((item) => {
          mutationObserver.observe(item, {
            childList: true,
            subtree: true,
            characterData: true,
          });
        });
      }

      // .loop-static からスクロール版を生成して横並びにする
      function createCompareLayout(staticContainer) {
        // 2カラムレイアウト用のラッパーを作成
        const compare = document.createElement("div");
        compare.className = "compare";

        // スクロール版カラム
        const scrollColumn = document.createElement("div");
        scrollColumn.className = "compare-column";
        const scrollTitle = document.createElement("h3");
        scrollTitle.textContent = "スクロールあり";
        scrollColumn.appendChild(scrollTitle);

        // staticContainer を clone してスクロール版を作成
        const loopContainer = staticContainer.cloneNode(true);
        loopContainer.className = "loop";
        loopContainer.removeAttribute("id");
        // clone内のidも削除（重複防止）
        loopContainer.querySelectorAll("[id]").forEach((el) => el.removeAttribute("id"));
        scrollColumn.appendChild(loopContainer);

        // 元要素カラム
        const staticColumn = document.createElement("div");
        staticColumn.className = "compare-column";
        const staticTitle = document.createElement("h3");
        staticTitle.textContent = "元要素";
        staticColumn.appendChild(staticTitle);

        // staticContainer をこのカラムに移動
        staticColumn.appendChild(staticContainer.cloneNode(true));

        compare.appendChild(staticColumn);
        compare.appendChild(scrollColumn);

        // 元の位置に挿入
        staticContainer.parentNode.replaceChild(compare, staticContainer);

        // スクロール版を初期化
        initLoop(loopContainer);
      }

      // 全てのリソース読み込み完了後に初期化
      window.addEventListener("load", () => {
        document.querySelectorAll(".loop-static").forEach(createCompareLayout);
      });

      // 3秒後に動的にテキストを設定（API取得を模擬）
      setTimeout(() => {
        const longText = "これはAPIから取得した長いテキストです。動的に設定されます。";
        const dynamicItem = document.getElementById("dynamic-item");
        if (dynamicItem) {
          dynamicItem.textContent = longText;
        }
      }, 3000);
    </script>
  </body>
</html>
